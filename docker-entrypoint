#!/bin/bash

if [ -z $CERTBOT_EMAIL ]; then
    printf "| CERTBOT_EMAIL is empty!"
    exit 1
fi

set -e

if [ "$DEBUG" = "1" ]; then
	set -x
	BASH_CMD_FLAGS='-x'
fi

printf "|---------------------------------------------------------------------------------------------\n";
printf "| Starting Docker Flow: Let's Encrypt\n"

# Load env vars
printf "| ENTRYPOINT: \033[0;31mLoading docker secrets if found...\033[0m\n"
for i in $(env|grep '/run/secrets')
do
	varName=$(echo $i|awk -F '[=]' '{print $1}'|sed 's/_FILE//')
	varFile=$(echo $i|awk -F '[=]' '{print $2}')
	eval "export $varName=$(cat $varFile)"
done

# Disable certbot if CERTBOT_DISABLE is defined
if [ "x$CERTBOT_DISABLE" = "x" ]; then
	printf "| ENTRYPOINT: \032[0;31mCertificate manager is enabled.\033[0m\n"
	/bin/bash $BASH_CMD_FLAGS /scripts/certbot.sh > /var/log/dockeroutput.log
else
	printf "| ENTRYPOINT: \033[0;31mCERTMGR_DISABLE variable is declared, stopping right here and sleeping forever\033[0m\n"
	printf "| ENTRYPOINT: \033[0;33mTo enable certificate management, please remove CERTBOT_DISABLE variable declaration and start the container again\033[0m\n"
	while true; do sleep 10000; done
fi

# Check if AWS R53 variables are declared.
if [ "x$AWS_ACCESS_KEY_ID" = "x" ]; then
	printf "| ENTRYPOINT: \033[0;31mAWS_ACCESS_KEY_ID/AWS_ACCESS_KEY_ID_FILE variable is not declared\033[0m\n"
	exit 1
fi

if [ "x$AWS_SECRET_ACCESS_KEY" = "x" ]; then
	printf "| ENTRYPOINT: \033[0;31mAWS_SECRET_ACCESS_KEY/AWS_SECRET_ACCESS_KEY_FILE variable is not declared\033[0m\n"
	exit 1
fi

if [ "x$AWS_HOSTED_ZONE_ID" = "x" ]; then
	printf "| ENTRYPOINT: \033[0;31mAWS_HOSTED_ZONE_ID/AWS_HOSTED_ZONE_ID_FILE variable is not declared\033[0m\n"
	exit 1
fi

if [ "x$AWS_REGION" = "x" ]; then
	export AWS_REGION=us-east-1
fi

printf "| ENTRYPOINT: \033[0;31mStarting supervisord (which starts and monitors cron) \033[0m\n"
printf "|---------------------------------------------------------------------------------------------\n";

/usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
